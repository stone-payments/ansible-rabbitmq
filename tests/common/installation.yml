---
- name: Get service status
  ansible.builtin.service_facts:
  register: service_facts

- name: Gather facts on listening ports
  community.general.listen_ports_facts:

- name: Set listening port list
  set_fact:
    listening_ports: "{{ ansible_facts.tcp_listen | map(attribute='port') | sort | list }}"

- name: Check if rabbitmq is running and enabled
  ansible.builtin.assert:
    that:
      - service_facts.ansible_facts.services['rabbitmq-server.service'].state == 'running'
      - service_facts.ansible_facts.services['rabbitmq-server.service'].status == 'enabled'
      - 4369 in {{ listening_ports }}
      - 5672 in {{ listening_ports }}
      - 15672 in {{ listening_ports }}
      - 25672 in {{ listening_ports }}
      
- name: Get rabbitmq version
  ansible.builtin.command: rabbitmqctl version
  register: version
  changed_when: false

- name: Check version
  ansible.builtin.assert:
    that:
      - 'rabbitmq_version in version.stdout'
