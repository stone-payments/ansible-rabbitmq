---
- name: Get service status
  ansible.builtin.service_facts:
  register: service_facts

- name: Gather facts on listening ports
  community.general.listen_ports_facts:

- name: Set listening port list
  set_fact:
    listening_ports: "{{ ansible_facts.tcp_listen | map(attribute='port') | sort | list }}"

- name: Check if rabbitmq is running and enabled
  ansible.builtin.assert:
    that:
      - service_facts.ansible_facts.services['rabbitmq-server.service'].state == 'running'
      - service_facts.ansible_facts.services['rabbitmq-server.service'].status == 'enabled'
      - 4369 in {{ listening_ports }}
      - 5672 in {{ listening_ports }}
      - 15672 in {{ listening_ports }}
      - 25672 in {{ listening_ports }}
      
- name: Get rabbitmq version
  ansible.builtin.command: rabbitmqctl version
  register: version
  changed_when: false

- name: Check version
  ansible.builtin.assert:
    that:
      - 'rabbitmq_version in version.stdout'

- name: Stat rabbitmq conf file
  ansible.builtin.stat:
    path: "{{ rabbitmq_config_file_path }}"
  register: file_stat

- name: Check default rabbitmq_config_file_path permissions
  ansible.builtin.assert:
    that:
      - file_stat.stat.exists == True
      - file_stat.stat.mode == '0644'
      - file_stat.stat.gr_name == '{{ rabbitmq_group }}'
      - file_stat.stat.pw_name == '{{ rabbitmq_owner }}'

- name: Get user list
  ansible.builtin.command: rabbitmqctl list_users
  register: users
  changed_when: false

- name: Check if guest user was removed
  ansible.builtin.assert:
    that:
      - '"guest" not in users.stdout'

- name: Get plugin list
  ansible.builtin.command: rabbitmq-plugins list -e -m
  register: plugins
  changed_when: false

- name: Check if plugins are enabled
  ansible.builtin.assert:
    that:
      - plugin.name in plugins.stdout_lines
  loop: "{{ rabbitmq_plugins }}"
  loop_control:
    loop_var: plugin